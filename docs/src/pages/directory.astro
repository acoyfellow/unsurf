---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';

const frontmatter = {
  title: 'Directory',
  description: 'Community-discovered APIs',
  template: 'splash',
};
---

<StarlightPage frontmatter={frontmatter}>
  <div class="directory" id="directory">
    
    <!-- HEADER -->
    <header class="header">
      <div class="stats">
        <span class="stat" id="api-count">0 APIs</span>
        <span class="stat-sep">·</span>
        <span class="stat" id="endpoint-count">0 endpoints</span>
        <span class="stat-sep">·</span>
        <a href="/reference/tools/#scout" class="docs-link">Docs</a>
      </div>
      <div class="search-box">
        <input type="text" id="search" placeholder="Search..." autocomplete="off" />
      </div>
    </header>

    <!-- TABLE -->
    <div class="table" id="table">
      <div class="table-header">
        <span class="col-domain">Domain</span>
        <span class="col-endpoints">Endpoints</span>
        <span class="col-actions"></span>
      </div>
      <div class="table-body" id="table-body"></div>
    </div>

    <!-- EMPTY -->
    <div class="empty" id="empty">No APIs found</div>

    <!-- ADD -->
    <div class="add-section">
      <input type="url" id="add-url" placeholder="https://api.example.com" />
      <button id="add-btn">Add API</button>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal-overlay">
      <div class="modal" id="modal">
        <div class="modal-header">
          <span class="modal-title" id="modal-title">—</span>
          <button class="modal-close" id="modal-close">×</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
        <div class="modal-footer" id="modal-footer"></div>
      </div>
    </div>

  </div>
</StarlightPage>

<style is:global>
  /* Hide Starlight chrome */
  [data-has-hero] .page {
    padding-top: 0 !important;
  }
  [data-has-hero] header.hero {
    display: none !important;
  }
  .sl-markdown-content {
    max-width: none;
  }

  /* Variables */
  .directory {
    --text: #1a1a1a;
    --text-muted: #666;
    --border: #e5e5e5;
    --bg: #fff;
    --bg-hover: #fafafa;
    --accent: #0066cc;
  }
  :root[data-theme='dark'] .directory {
    --text: #e5e5e5;
    --text-muted: #999;
    --border: #333;
    --bg: #1a1a1a;
    --bg-hover: #222;
    --accent: #4d9fff;
  }

  .directory {
    font-family: system-ui, -apple-system, sans-serif;
    color: var(--text);
    padding: 2rem 0; /* horizontal padding from .sl-container */
  }

  /* Header */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .stats {
    font-size: 0.875rem;
    color: var(--text-muted);
  }
  .stat-sep {
    margin: 0 0.5rem;
  }
  .docs-link {
    color: var(--text-muted);
    text-decoration: none;
  }
  .docs-link:hover {
    color: var(--accent);
  }
  .search-box input {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.875rem;
    background: var(--bg);
    color: var(--text);
    width: 200px;
  }
  .search-box input:focus {
    outline: none;
    border-color: var(--accent);
  }

  /* Table */
  .table {
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }
  .table-header {
    display: grid;
    grid-template-columns: 1fr 100px 80px;
    padding: 0.75rem 1rem;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    background: var(--bg-hover);
  }
  .table-body {
    max-height: 500px;
    overflow-y: auto;
  }
  .table-row {
    display: grid;
    grid-template-columns: 1fr 100px 80px;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
  }
  .table-row:last-child {
    border-bottom: none;
  }
  .table-row:hover {
    background: var(--bg-hover);
  }
  .row-domain {
    font-weight: 500;
    color: var(--text);
  }
  .row-endpoints {
    color: var(--text-muted);
    font-size: 0.875rem;
  }
  .row-action {
    text-align: right;
  }
  .row-action a {
    color: var(--accent);
    text-decoration: none;
    font-size: 0.875rem;
  }
  .row-action a:hover {
    text-decoration: underline;
  }

  /* Empty */
  .empty {
    display: none;
    padding: 3rem;
    text-align: center;
    color: var(--text-muted);
  }
  .empty.visible {
    display: block;
  }

  /* Add section */
  .add-section {
    margin-top: 2rem;
    display: flex;
    gap: 0.5rem;
  }
  .add-section input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.875rem;
    background: var(--bg);
    color: var(--text);
  }
  .add-section button {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    color: var(--text);
    font-size: 0.875rem;
    cursor: pointer;
    transition: background 0.1s;
  }
  .add-section button:hover {
    background: var(--bg-hover);
  }
  .add-section button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open {
    display: flex;
  }
  .modal {
    background: var(--bg);
    border-radius: 6px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border);
  }
  .modal-title {
    font-weight: 600;
    font-size: 1rem;
  }
  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
    line-height: 1;
  }
  .modal-body {
    padding: 1rem;
    overflow-y: auto;
    flex: 1;
  }
  .modal-footer {
    padding: 1rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
  }
  .modal-footer a {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.875rem;
    color: var(--text);
  }
  .modal-footer a:hover {
    background: var(--bg-hover);
  }
  .modal-footer a.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  /* Endpoint list */
  .endpoint-list {
    font-size: 0.875rem;
  }
  .endpoint-item {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
  }
  .endpoint-play {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
    border: 1px solid var(--border);
    border-radius: 3px;
    background: var(--bg);
    color: var(--text);
    cursor: pointer;
  }
  .endpoint-play:hover:not(:disabled) {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }
  .endpoint-play:disabled {
    cursor: not-allowed;
    opacity: 0.7;
  }
  .endpoint-result {
    width: 100%;
    margin-top: 0.5rem;
    padding: 0.5rem;
    font-family: ui-monospace, monospace;
    font-size: 0.75rem;
    max-height: 150px;
    overflow: auto;
    background: var(--bg-hover);
    border-radius: 4px;
    white-space: pre-wrap;
    word-break: break-all;
  }
  .endpoint-result.error {
    color: #991b1b;
  }
  .endpoint-item:last-child {
    border-bottom: none;
  }
  .endpoint-method {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    background: #e5e5e5;
    color: #333;
  }
  .endpoint-method.get { background: #dcfce7; color: #166534; }
  .endpoint-method.post { background: #dbeafe; color: #1e40af; }
  .endpoint-method.put { background: #fef3c7; color: #92400e; }
  .endpoint-method.delete { background: #fee2e2; color: #991b1b; }
  .endpoint-path {
    font-family: ui-monospace, monospace;
    font-size: 0.8rem;
    color: var(--text-muted);
  }
</style>

<script>
  const API = 'https://unsurf-api.coey.dev';
  let allApis = [];
  let currentDomain = null;

  const tableBody = document.getElementById('table-body');
  const empty = document.getElementById('empty');
  const search = document.getElementById('search');
  const apiCount = document.getElementById('api-count');
  const endpointCount = document.getElementById('endpoint-count');
  const modalOverlay = document.getElementById('modal-overlay');
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');
  const modalFooter = document.getElementById('modal-footer');
  const addUrl = document.getElementById('add-url');
  const addBtn = document.getElementById('add-btn');

  // Load data
  async function load() {
    try {
      const res = await fetch(`${API}/d/`);
      const data = await res.json();
      allApis = data.fingerprints || [];
      const totalEndpoints = allApis.reduce((sum, a) => sum + a.endpoints, 0);
      apiCount.textContent = `${allApis.length} APIs`;
      endpointCount.textContent = `${totalEndpoints} endpoints`;
      render(allApis);
    } catch (e) {
      console.error(e);
      empty.classList.add('visible');
    }
  }

  // Render table
  function render(apis) {
    if (apis.length === 0) {
      tableBody.innerHTML = '';
      empty.classList.add('visible');
      return;
    }
    empty.classList.remove('visible');
    tableBody.innerHTML = apis.map(api => `
      <div class="table-row" data-domain="${api.domain}">
        <span class="row-domain">${api.domain}</span>
        <span class="row-endpoints">${api.endpoints}</span>
        <span class="row-action"><a href="${API}/d/${api.domain}/spec" target="_blank">spec</a></span>
      </div>
    `).join('');

    // Click handlers
    tableBody.querySelectorAll('.table-row').forEach(row => {
      row.addEventListener('click', (e) => {
        if (e.target.tagName === 'A') return;
        openModal(row.dataset.domain);
      });
    });
  }

  // Search
  search.addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    const filtered = allApis.filter(a => a.domain.toLowerCase().includes(q));
    render(filtered);
  });

  // Modal
  async function openModal(domain) {
    currentDomain = domain;
    modalTitle.textContent = domain;
    modalBody.innerHTML = 'Loading...';
    modalFooter.innerHTML = '';
    modalOverlay.classList.add('open');

    try {
      const res = await fetch(`${API}/d/${domain}/spec`);
      const spec = await res.json();
      const paths = spec.paths || {};
      
      const endpoints = [];
      for (const [path, methods] of Object.entries(paths)) {
        for (const method of Object.keys(methods)) {
          if (['get','post','put','delete','patch'].includes(method.toLowerCase())) {
            endpoints.push({ method: method.toUpperCase(), path });
          }
        }
      }

      if (endpoints.length === 0) {
        modalBody.innerHTML = '<p style="color:var(--text-muted)">No endpoints</p>';
      } else {
        modalBody.innerHTML = `
          <div class="endpoint-list">
            ${endpoints.map(e => `
              <div class="endpoint-item" data-method="${e.method}" data-path="${e.path}">
                <button class="endpoint-play" title="Try endpoint">Play</button>
                <span class="endpoint-method ${e.method.toLowerCase()}">${e.method}</span>
                <span class="endpoint-path">${e.path}</span>
                <div class="endpoint-result"></div>
              </div>
            `).join('')}
          </div>
        `;
        modalBody.querySelectorAll('.endpoint-play').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const item = btn.closest('.endpoint-item');
            const resultEl = item.querySelector('.endpoint-result');
            const method = item.dataset.method;
            const path = item.dataset.path;
            btn.disabled = true;
            btn.textContent = '…';
            resultEl.textContent = '';
            resultEl.classList.remove('error');
            try {
              const res = await fetch(`${API}/d/invoke`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain, method, path })
              });
              const data = await res.json();
              if (data.error) throw new Error(data.error);
              resultEl.textContent = JSON.stringify(data.body, null, 2);
              if (!data.ok) resultEl.classList.add('error');
            } catch (err) {
              resultEl.textContent = err instanceof Error ? err.message : String(err);
              resultEl.classList.add('error');
            } finally {
              btn.disabled = false;
              btn.textContent = 'Play';
            }
          });
        });
      }

      modalFooter.innerHTML = `
        <a href="https://${domain}" target="_blank">Visit</a>
        <a href="${API}/d/${domain}/spec" target="_blank" class="primary">OpenAPI</a>
      `;
    } catch (e) {
      modalBody.innerHTML = '<p style="color:#991b1b">Failed to load</p>';
    }
  }

  function closeModal() {
    modalOverlay.classList.remove('open');
    currentDomain = null;
  }

  document.getElementById('modal-close').addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });

  // Add API
  addBtn.addEventListener('click', async () => {
    const url = addUrl.value.trim();
    if (!url) return;
    
    addBtn.disabled = true;
    addBtn.textContent = 'Scouting...';
    
    try {
      const res = await fetch(`${API}/tools/scout`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, task: 'discover API', publish: true, force: true })
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      addUrl.value = '';
      load();
    } catch (e) {
      alert('Failed: ' + e.message);
    } finally {
      addBtn.disabled = false;
      addBtn.textContent = 'Add API';
    }
  });

  // Init
  load();
</script>
